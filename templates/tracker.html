<!DOCTYPE html>
<html>
<head>
    <title>Error Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .footer {
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  height:60px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  color:#474747;
  z-index:1000;

  background:rgba(255,255,255,0.1);  /* semi-transparent white */
  backdrop-filter:blur(12px) saturate(180%);
  -webkit-backdrop-filter:blur(12px) saturate(180%);
  border-top:1px solid rgba(255,255,255,0.25);
}
.footer p {
  margin:0;
  font-weight:500;
  letter-spacing:0.5px;
}
        body { background-color: #bebebe; font-family: 'Segoe UI', sans-serif; margin: 0; }
        .header-bar { position: sticky; top: 0; z-index: 999; background-color: #ffffff; padding: 15px 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
        .container-fluid { width: 100%; padding: 10px; }
        
        table { table-layout: fixed; width: 100%; margin-top: 20px; border-collapse: collapse; background-color: #fff; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: middle; height: 25px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px; }
        .table thead th { position: sticky; top: 83px; z-index: 100; background-color: #639df5; font-weight: bold; font-size: 13px; }
        tr.expanded td { white-space: normal !important; word-break: break-word !important; height: auto !important; overflow: visible !important; }
        .highlighted { background-color: #dbeafe !important; }
        thead select { font-size: 12px; padding: 4px; width: 100%; border-radius: 4px; }
        .btn-custom-save { background-color: #4B0082; color: white; border: none; }
        .btn-custom-save:hover { background-color: #3a006b; }
        .dropdown-menu { min-width: 300px; max-width: 500px; white-space: normal; word-break: break-all; }
        .modal-content { border-radius: 10px; }
        .modal-header h5 { font-weight: 600; }
        .rounded-circle-btn { width: 50px; height: 50px; border-radius: 50%; padding: 0; background-color: #ffffff; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid #888888; }
        .rounded-circle-btn img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .clickable-empty { color: #0d6efd; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 4px; }
        .clickable-empty::before { content: "+"; font-weight: bold; }
    </style>
</head>
<body>
<!-- Footer -->
  <footer class="footer">
    <p>¬© 2025 Datasolve Analytics ‚Äî All Rights Reserved</p>
  </footer>
<!-- Header -->
<div class="header-bar d-flex justify-content-between align-items-center">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" style="height: 50px;">
    <img src="https://storage.googleapis.com/my-react-image-bucket-123/FixHop_Logo.gif" alt="GIF" style="height: 60px;">
    <div class="d-flex align-items-center gap-3">
        <a href="http://34.47.164.153:8080/" class="btn btn-light rounded-circle">
            <img src="{{ url_for('static', filename='home.png') }}" alt="Home" style="width:20px;height:20px;">
        </a>
        <a href="/logout" class="btn btn-light rounded-circle">
            <img src="{{ url_for('static', filename='log.png') }}" alt="Logout" style="width:20px;height:20px;">
        </a>
        <span class="text-dark fw-semibold" style="font-size:16px;">{{ username }}</span>
        <div class="dropdown">
            <button class="btn rounded-circle-btn" type="button" data-bs-toggle="dropdown" title="{{ profile_name or user_email }}">
                <img src="{{ profile_image_url or gravatar_url(user_email,64,'identicon') or url_for('static', filename='ico.png') }}" 
                     alt="Profile"
                     onerror="this.onerror=null; this.src='{{ url_for('static', filename='ico.png') }}';"/>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li class="dropdown-item-text small text-muted">{{ user_email }}</li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/log">InSolvo</a></li>
                <li><a class="dropdown-item" href="/loga">Analytica</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/logout">Logout</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Table -->
<div class="container-fluid">
    <table id="errorTable" class="table table-bordered shadow-sm">
        <thead>
        <tr>
            {% for head in ["ID","Users","Tool Name","Error","Solution","Developer","Start Date","Start Time","End Time","Runtime","Remarks","App Name","Action"] %}
                <th>{{ head }}<br><select onchange="filterDropdown({{ loop.index0 }}, this.value)"><option value="">All</option></select></th>
            {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% for row in data %}
        <tr id="row-{{ row['id'] }}" class="expandable-row" onclick="expandRow(this)">
            <form id="form-{{ row['id'] }}" method="POST" action="/approve">
                <td>{{ row['id'] }}<input type="hidden" name="id" value="{{ row['id'] }}"></td>
                <td>{{ row['Users'] }}</td>
                <td>{{ row['Tool_Name'] }}</td>
                <td>{{ row['Error'] }}</td>

                <!-- Solution -->
                <td onclick="openEditModal('{{ row['id'] }}','solution',document.getElementById('solution-input-{{ row['id'] }}').value)">
                    <span id="solution-display-{{ row['id'] }}" class="{{ 'clickable-empty' if not row['Solution'] else '' }}">{{ row['Solution'] or 'Click to add...' }}</span>
                    <input type="hidden" name="solution" id="solution-input-{{ row['id'] }}" value="{{ row['Solution'] or '' }}">
                </td>

                <!-- Developer -->
                <td onclick="openEditModal('{{ row['id'] }}','developer',document.getElementById('developer-input-{{ row['id'] }}').value)">
                    <span id="developer-display-{{ row['id'] }}" class="{{ 'clickable-empty' if not row['Developer'] else '' }}">{{ row['Developer'] or 'Click to add...' }}</span>
                    <input type="hidden" name="developer" id="developer-input-{{ row['id'] }}" value="{{ row['Developer'] or '' }}">
                </td>

                <td>{{ row['Start_Date'] }}</td>
                <td>{{ row['Start_Time'] }}</td>
                <td>{{ row['End_Time'] }}</td>
                <td>{{ row['Runtime'] }}</td>

                <!-- Remarks -->
                <td onclick="openEditModal('{{ row['id'] }}','remarks',document.getElementById('remarks-input-{{ row['id'] }}').value)">
                    <span id="remarks-display-{{ row['id'] }}" class="{{ 'clickable-empty' if not row['Remarks'] else '' }}">{{ row['Remarks'] or 'Click to add...' }}</span>
                    <input type="hidden" name="remarks" id="remarks-input-{{ row['id'] }}" value="{{ row['Remarks'] or '' }}">
                </td>

                <td>{{ row['App_Name'] or '' }}</td>
                <td>
                    {% if row['Solution'] or row['Developer'] or row['Remarks'] %}
                        <button type="button" class="btn btn-warning btn-sm" onclick="openPasswordModal({{ row['id'] }}); event.stopPropagation();">Edit</button>
                    {% else %}
                        <button type="submit" class="btn btn-success btn-sm" onclick="switchToEdit({{ row['id'] }}); event.stopPropagation();">Approve</button>
                    {% endif %}
                </td>
            </form>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- Password Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Enter Password to Edit</h5></div>
    <div class="modal-body">
      <input type="password" id="modalPassword" class="form-control" placeholder="Enter Password">
      <input type="hidden" id="editingRowId">
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button class="btn btn-success" onclick="validatePassword()">Unlock</button>
    </div>
  </div></div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Edit Field</h5></div>
    <div class="modal-body">
      <textarea id="editText" class="form-control" rows="4"></textarea>
      <input type="hidden" id="editRowId">
      <input type="hidden" id="editColumn">
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button class="btn btn-success" onclick="saveEdit()">Save</button>
    </div>
  </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let modal = new bootstrap.Modal(document.getElementById('passwordModal'));
let editModal = new bootstrap.Modal(document.getElementById('editModal'));

function switchToEdit(rowId){
    const row=document.getElementById(`row-${rowId}`);
    row.classList.add("approved"); // lock after approve
    document.querySelector(`#row-${rowId} td:last-child`).innerHTML =
        `<button type="button" class="btn btn-warning btn-sm" onclick="openPasswordModal(${rowId}); event.stopPropagation();">Edit</button>`;
}

function openPasswordModal(id){
    const row=document.getElementById(`row-${id}`);
    if(!row.classList.contains("approved")){
        alert("‚ö†Ô∏è Row not approved yet.");
        return;
    }
    document.getElementById('modalPassword').value='';
    document.getElementById('editingRowId').value=id;
    modal.show();
}

function validatePassword(){
    const password=document.getElementById('modalPassword').value;
    const rowId=document.getElementById('editingRowId').value;
    if(password==='1111'){
        const row=document.getElementById(`row-${rowId}`);
        row.classList.remove("approved"); // unlock for editing
        modal.hide();
        // Show Save button (submit type)
        document.querySelector(`#row-${rowId} td:last-child`).innerHTML =
            `<button type="submit" class="btn btn-custom-save btn-sm" onclick="event.stopPropagation();">Save</button>`;
    } else {
        alert("‚ùå Incorrect Password");
    }
}

function expandRow(row){
    document.querySelectorAll('.expandable-row').forEach(r=>r.classList.remove('expanded','highlighted'));
    row.classList.add('expanded','highlighted');
}

function filterDropdown(colIndex,value){
    document.querySelectorAll("#errorTable tbody tr").forEach(row=>{
        const cellText=row.querySelectorAll("td")[colIndex]?.innerText.trim();
        row.style.display=(value===""||cellText===value)?"":"none";
    });
}

function openEditModal(rowId,column,currentValue){
    const row=document.getElementById(`row-${rowId}`);
    if(row.classList.contains("approved")){
        alert("üîí Row is approved. Enter password via Edit button to unlock.");
        return;
    }
    document.getElementById('editText').value=currentValue||"";
    document.getElementById('editRowId').value=rowId;
    document.getElementById('editColumn').value=column;
    editModal.show();
}

function saveEdit(){
    const rowId=document.getElementById('editRowId').value;
    const column=document.getElementById('editColumn').value;
    const newValue=document.getElementById('editText').value.trim();

    // Update UI
    const span=document.getElementById(`${column}-display-${rowId}`);
    span.innerText=newValue||"Click to add...";
    span.className=newValue?"":"clickable-empty";
    document.getElementById(`${column}-input-${rowId}`).value=newValue;

    // AJAX call to backend
    const form=document.getElementById(`form-${rowId}`);
    const formData=new FormData(form);
    formData.set(column,newValue); // update changed column

    fetch("/approve", {
        method: "POST",
        body: formData
    })
    .then(res=>{
        if(res.ok){
            console.log("‚úÖ Saved in DB");
        } else {
            alert("‚ùå DB Save Failed");
        }
    })
    .catch(err=>alert("‚ùå Error: "+err));

    editModal.hide();
}
</script>
</body>
</html>
